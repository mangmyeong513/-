<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OVRA â€“ ì‰í¬ê³ ì–‘ì´ ì»¤ë®¤ë‹ˆí‹°</title>
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root{
        --paper:#fbfbfb;           /* ì¢…ì´ìƒ‰ ë°°ê²½ */
        --ink:#0b0b0b;             /* ë¨¹ìƒ‰ */
        --ink-soft:#1a1a1a;        /* ì—°ë¨¹ */
        --line:#e6e6e6;            /* ì¢…ì´ ìœ„ ì—°í•œ ì„  */
        --text:#1c1c1c;            /* ë³¸ë¬¸ */
        --muted:#777;              /* ë³´ì¡° */
        --accent:#111;             /* ë²„íŠ¼/í¬ì»¤ìŠ¤ */
      }
      html,body{background:var(--paper);color:var(--text)}
      .btn{padding:.5rem .9rem;border-radius:.8rem;background:var(--ink);color:#fff;border:1px solid #00000014}
      .btn-sub{padding:.45rem .8rem;border-radius:.7rem;background:#fff;border:1px solid var(--line);color:var(--text)}
      .chip{padding:.25rem .6rem;border-radius:999px;background:#fff;border:1px solid var(--line);font-size:.72rem;color:var(--muted)}
      .card{border:1px solid var(--line);background:#fff;border-radius:1.25rem}
      .line-clamp-2{-webkit-line-clamp:2;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden}
      .line-clamp-4{-webkit-line-clamp:4;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden}
      @keyframes float {0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
      .animate-float{animation:float 7s ease-in-out infinite}
    </style>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>

    <!-- React 18 UMD + Babel for JSX in one file -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      // -------------------------------------------------------------
      // Ink-cat decoration (SVGs with soft blur)
      // -------------------------------------------------------------
      const InkCat = ({ className = "", mood = 0, alpha = 0.85 }) => {
        const poses = [
          "M50 70 C40 80 30 95 35 105 C55 120 110 120 130 105 C140 95 130 80 120 70 C130 40 115 30 100 30 C85 30 70 40 75 58 C60 58 55 60 50 70 Z",
          "M55 95 C45 105 45 115 65 120 C80 124 120 124 135 116 C145 110 145 98 130 92 C138 80 130 64 110 64 C95 64 85 68 82 76 C75 72 64 78 60 86 Z",
          "M40 90 C30 100 30 112 48 120 C80 132 130 124 150 110 C160 100 158 88 142 84 C150 70 140 55 118 58 C98 61 90 70 88 78 C80 74 60 76 52 84 Z",
          "M60 78 C48 90 48 106 66 114 C88 124 128 124 146 112 C158 104 154 86 136 84 C142 70 130 56 110 58 C92 60 80 70 78 78 C72 74 64 74 60 78 Z",
        ];
        return (
          <svg viewBox="0 0 180 140" className={className} aria-hidden>
            <defs>
              <filter id="inkBlur" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="5"/></filter>
              <radialGradient id="inkSoft" cx="50%" cy="50%" r="60%">
                <stop offset="0%" stopColor="#161616"/>
                <stop offset="100%" stopColor="#0b0b0b"/>
              </radialGradient>
            </defs>
            {/* tail */}
            <path d="M20 110 C40 120 60 130 80 120 C100 110 95 95 85 92" stroke="#0b0b0b" strokeWidth="18" strokeLinecap="round" filter="url(#inkBlur)" opacity={alpha}/>
            {/* body */}
            <path d={poses[mood % poses.length]} fill="url(#inkSoft)" filter="url(#inkBlur)" opacity={alpha} />
            {/* ears */}
            <path d="M85 40 L95 20 L105 40 Z" fill="#0b0b0b" filter="url(#inkBlur)" opacity={alpha} />
            <path d="M110 42 L122 22 L130 45 Z" fill="#0b0b0b" filter="url(#inkBlur)" opacity={alpha} />
            {/* eyes */}
            <ellipse cx="96" cy="63" rx="6" ry="7" fill="#fff" opacity=".95" />
            <ellipse cx="118" cy="64" rx="6" ry="7" fill="#fff" opacity=".95" />
          </svg>
        );
      };

      const InkSmudge = ({ className = "" }) => (
        <svg viewBox="0 0 200 120" className={className} aria-hidden>
          <defs><filter id="sm" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="8"/></filter></defs>
          <path d="M10,90 C25,20 80,5 110,38 C140,15 175,25 190,70 C140,75 120,95 100,110 C80,100 45,95 10,90 Z" fill="#0f0f0f" filter="url(#sm)" opacity=".10"/>
        </svg>
      );

      // -------------------------------------------------------------
      // Utils & storage
      // -------------------------------------------------------------
      const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
      const load=(k,def)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}};
      const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
      const randomNick=()=>{const adj=["ê·¸ì„ë¦°","ì—°ë¬´","ë¨¹ë¬¼","ì•ˆê°œ","ê³ ìš”","ìƒˆë²½","íë¦¼","ë°˜ì ","ë¬µí–¥"], ani=["ê³ ì–‘ì´","ë¹„ë‘˜ê¸°","ìˆ˜ë‹¬","ë„ˆêµ¬ë¦¬","ì œë¹„"];return adj[Math.floor(Math.random()*adj.length)]+ani[Math.floor(Math.random()*ani.length)]+"#"+Math.floor(100+Math.random()*900)};

      const STOP=["ê·¸ë¦¬ê³ ","ê·¸ë˜ì„œ","í•˜ì§€ë§Œ","ê·¸ëŸ¬ë‚˜","ë‚˜ëŠ”","ìš°ë¦¬ëŠ”","ë„ˆëŠ”","ì˜¤ëŠ˜","ì§€ê¸ˆ","ì •ë§","ì•½ê°„","ë„ˆë¬´","ì§„ì§œ","ê·¸ëƒ¥","ê·¼ë°","í•˜ë©´","í•˜ë ¤ê³ ","í•´ì„œ","í•˜ë‹¤","í–ˆë‹¤","í•˜ëŠ”","í–ˆë”ë‹ˆ","ìˆë‹¤","ì—†ë‹¤","ê°™ë‹¤","ë³´ë‹¤"]; 
      const MAP={"ìš°ìš¸":"ìœ„ë¡œ","ìŠ¬í¼":"ìœ„ë¡œ","í˜ë“¤":"ìœ„ë¡œ","ë¶ˆì•ˆ":"ìœ„ë¡œ","í–‰ë³µ":"ê¸°ì¨","ê¸°ë»":"ê¸°ì¨","ì‹œí—˜":"ìˆ˜ëŠ¥","ìˆ˜ëŠ¥":"ìˆ˜ëŠ¥","ê³µë¶€":"ê³µë¶€","ê³¼ì œ":"ê³µë¶€","ì¹œêµ¬":"ì¹œêµ¬","ì—°ì• ":"ì—°ì• ","ì‚¬ë‘":"ì—°ì• ","ê²Œì„":"ê²Œì„","ê·¸ë¦¼":"ê·¸ë¦¼","ìŒì•…":"ìŒì•…","ë…¸ë˜":"ìŒì•…","í•™êµ":"í•™êµ","ë¶€ëª¨":"ê°€ì¡±","ì—„ë§ˆ":"ê°€ì¡±","ì•„ë¹ ":"ê°€ì¡±","ìš´ë™":"ìš´ë™","ë‚ ì”¨":"ë‚ ì”¨","ë¹„":"ë‚ ì”¨","ë”ì›Œ":"ë‚ ì”¨","ì¶”ì›Œ":"ë‚ ì”¨"};
      const tokenize=t=> (t||"").toLowerCase().replace(/[\n.,!?~\-()\[\]{}'";:]/g," ").split(/\s+/).filter(Boolean);
      function suggestTags(text,extra=""){const words=[...tokenize(text),...tokenize(extra)];const counts={};for(const w of words){if(w.length<2||STOP.includes(w)) continue;const key=MAP[w]||w;counts[key]=(counts[key]||0)+1}const prefer=["ìœ„ë¡œ","ê¸°ì¨","ìˆ˜ëŠ¥","ê³µë¶€","ì¹œêµ¬","ì—°ì• ","ê²Œì„","ê·¸ë¦¼","ìŒì•…","í•™êµ","ê°€ì¡±","ìš´ë™","ë‚ ì”¨"];const arr=Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([k])=>k);const chosen=[];for(const p of prefer){if(arr.includes(p)) chosen.push(p)}for(const a of arr){if(!chosen.includes(a)) chosen.push(a)}return chosen.slice(0,3)}

      async function fileToDataURL(file){
        const bitmap = await createImageBitmap(file);
        const maxW = 1200; const scale = Math.min(1, maxW/bitmap.width);
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(bitmap.width*scale);
        canvas.height = Math.round(bitmap.height*scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bitmap,0,0,canvas.width,canvas.height);
        return canvas.toDataURL('image/jpeg', 0.82);
      }

      // -------------------------------------------------------------
      // Schema keys
      // -------------------------------------------------------------
      const DB='ovra_ink_posts';
      const NICK='ovra_ink_nick';

      // -------------------------------------------------------------
      // Small atoms
      // -------------------------------------------------------------
      const Header=({nick,onSearch,onNav,view})=> (
        <header className="sticky top-0 z-40 bg-white/70 backdrop-blur border-b border-[var(--line)]">
          <div className="relative mx-auto max-w-3xl px-4 py-3 flex items-center gap-3 justify-between">
            <div className="flex items-center gap-2">
              <div className="relative w-10 h-8">
                <InkSmudge className="absolute -top-6 -left-2 w-20"/>
                <InkCat className="absolute -top-5 -left-6 w-16" alpha={0.6} />
              </div>
              <h1 className="text-lg font-extrabold tracking-wide" style={{color:'var(--ink)'}}>OVRA</h1>
            </div>
            <input onChange={e=>onSearch(e.target.value)} placeholder="ê²€ìƒ‰â€¦" className="flex-1 max-w-md rounded-xl px-3 py-2 bg-white border border-[var(--line)] outline-none placeholder-[var(--muted)]"/>
            <nav className="flex items-center gap-3 text-sm text-[var(--muted)]">
              <button className={"hover:underline "+(view.mode==='feed'?"font-semibold text-[var(--ink)]":"")} onClick={()=>onNav({mode:'feed'})}>í”¼ë“œ</button>
              <button className={"hover:underline "+(view.mode==='profile'&&view.who==='me'?"font-semibold text-[var(--ink)]":"")} onClick={()=>onNav({mode:'profile',who:'me'})}>ë‚´ ê¸€</button>
              <button className={"hover:underline "+(view.mode==='bookmarks'?"font-semibold text-[var(--ink)]":"")} onClick={()=>onNav({mode:'bookmarks'})}>ë¶ë§ˆí¬</button>
            </nav>
            <span className="text-xs text-[var(--muted)]">{nick}</span>
          </div>
        </header>
      );

      const Tag=({children})=> (<span className="chip">#{children}</span>);

      const Confirm=({open,text,onYes,onNo})=> open? (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/20" onClick={onNo}></div>
          <div className="absolute inset-0 m-auto max-w-sm h-fit p-4 card">
            <p className="mb-4 text-sm text-[var(--muted)]">{text}</p>
            <div className="flex justify-end gap-2">
              <button className="btn-sub" onClick={onNo}>ì·¨ì†Œ</button>
              <button className="btn" style={{background:'#d93025'}} onClick={onYes}>í™•ì¸</button>
            </div>
          </div>
        </div>
      ):null;

      const PostCard=({post,me,onOpen,onQuote,onLike,onBookmark,onAuthor,onDelete,onReport,liked,bm})=> (
        <article className="card overflow-hidden">
          <div className="relative p-4">
            <InkSmudge className="absolute -top-8 -right-6 w-40 animate-float pointer-events-none"/>
            <div className="flex items-center gap-2 text-xs text-[var(--muted)]">
              <div className="h-8 w-8 rounded-full bg-white border border-[var(--line)] flex items-center justify-center" style={{color:'var(--muted)'}}>{post.author[0]}</div>
              <button className="hover:underline" onClick={()=>onAuthor(post.author)}>{post.author}</button>
              <span>Â· {new Date(post.ts).toLocaleString()}</span>
            </div>
            <h3 className="mt-2 font-semibold">{post.title||"(ì œëª© ì—†ìŒ)"}</h3>
            <p className="mt-1 leading-relaxed line-clamp-4">{post.body}</p>
            {post.image && <img src={post.image} alt="ì´ë¯¸ì§€" className="mt-3 rounded-xl border border-[var(--line)] max-h-96 object-contain w-full bg-white"/>}
            {post.quoteOf && (
              <div className="mt-3 p-3 rounded-xl border border-[var(--line)] bg-white">
                <div className="text-[10px] text-[var(--muted)] mb-1">ì˜´í‘œ</div>
                <div className="text-sm font-semibold">{post.quoteOf.title}</div>
                <div className="text-xs text-[var(--muted)]">{post.quoteOf.author}</div>
                <div className="text-sm">{post.quoteOf.body}</div>
              </div>
            )}
            <div className="mt-3 flex flex-wrap gap-2">{post.tags.map(t=> <Tag key={t}>{t}</Tag>)}</div>
          </div>
          <div className="flex items-center justify-between border-t border-[var(--line)] px-3 py-2 text-sm text-[var(--muted)]">
            <div className="flex gap-4 items-center">
              <button onClick={()=>onLike(post.id)} className={liked?"font-semibold text-[var(--ink)]":""}>{liked?'â™¥':'â™¡'} {post.likes||0}</button>
              <button onClick={()=>onOpen(post)}>ëŒ“ê¸€ {post.comments.length}</button>
              <button onClick={()=>onQuote(post)}>ì˜´í‘œ</button>
              <button onClick={()=>onBookmark(post.id)} className={bm?"font-semibold text-[var(--ink)]":""}>{bm?'ğŸ”–í•´ì œ':'ğŸ”–ë¶ë§ˆí¬'}</button>
            </div>
            <div className="flex gap-3 items-center">
              <button onClick={()=>onReport(post.id)}>ì‹ ê³ {post.reports?`(${post.reports})`:''}</button>
              {me===post.author && <button onClick={()=>onDelete(post.id)}>ì‚­ì œ</button>}
            </div>
          </div>
        </article>
      );

      const Composer=({nick,quoteTarget,onCancelQuote,onPost})=>{
        const [title,setTitle]=React.useState("");
        const [body,setBody]=React.useState("");
        const [tags,setTags]=React.useState([]);
        const [tagInput,setTagInput]=React.useState("");
        const [img,setImg]=React.useState(null);
        React.useEffect(()=>{setTags(suggestTags(title+" "+body))},[title,body]);
        const addTag=()=>{if(tagInput && !tags.includes(tagInput)) setTags([...tags,tagInput]);setTagInput("")}
        const onFile=async(e)=>{const f=e.target.files?.[0]; if(!f) return; const url=await fileToDataURL(f); setImg(url)}
        const submit=()=>{if(!title.trim()&&!body.trim()&&!img) return; onPost({title,body,tags,quoteTarget,image:img}); setTitle(""); setBody(""); setTags([]); setImg(null)}
        return (
          <div className="card p-4">
            <div className="flex gap-3">
              <div className="h-10 w-10 shrink-0 rounded-full bg-white border border-[var(--line)] flex items-center justify-center" style={{color:'var(--muted)'}}>{nick[0]}</div>
              <div className="flex-1">
                <input value={title} onChange={e=>setTitle(e.target.value.slice(0,60))} placeholder="ì œëª© (ìµœëŒ€ 60ì)" className="w-full mb-2 rounded-lg px-3 py-2 bg-white border border-[var(--line)] outline-none placeholder-[var(--muted)]"/>
                <textarea value={body} onChange={e=>setBody(e.target.value.slice(0,300))} placeholder="í•œë‘ ì¤„ë¡œ ì ì–´ë³´ì„¸ìš”â€¦ (ìµœëŒ€ 300ì)" className="w-full min-h-24 resize-y rounded-lg bg-white placeholder-[var(--muted)] p-3 outline-none border border-[var(--line)]"/>
                {img && <img src={img} className="mt-2 rounded-lg border border-[var(--line)] max-h-72 object-contain"/>}
                <div className="mt-2 flex items-center gap-2 flex-wrap">
                  {tags.map(t=> <span key={t} className="chip">#{t}</span>)}
                  <input value={tagInput} onChange={e=>setTagInput(e.target.value)} placeholder="#íƒœê·¸ì¶”ê°€" className="rounded-lg px-2 py-1 bg-white border border-[var(--line)] outline-none"/>
                  <button className="text-xs text-[var(--muted)]" onClick={addTag}>ì¶”ê°€</button>
                  <label className="ml-auto text-xs cursor-pointer text-[var(--muted)] hover:underline">
                    <input type="file" accept="image/*" className="hidden" onChange={onFile}/>
                    ì´ë¯¸ì§€ ì—…ë¡œë“œ
                  </label>
                </div>
                {quoteTarget && (
                  <div className="mt-3 p-3 rounded-xl border border-[var(--line)] bg-white">
                    <div className="text-[10px] text-[var(--muted)] mb-1">ì˜´í‘œ ëŒ€ìƒ</div>
                    <div className="font-semibold">{quoteTarget.title}</div>
                    <div className="text-[var(--muted)] text-xs">{quoteTarget.author}</div>
                    <div>{quoteTarget.body}</div>
                    <button className="mt-2 text-xs text-[var(--muted)] underline" onClick={onCancelQuote}>ì˜´í‘œ ì·¨ì†Œ</button>
                  </div>
                )}
                <div className="mt-3 flex justify-end"><button className="btn" onClick={submit}>ê²Œì‹œ</button></div>
              </div>
            </div>
          </div>
        )
      };

      const PostDetail=({me,post,onClose,onAddComment,onDeleteComment,onQuote})=>{
        const [txt,setTxt]=React.useState("");
        const submit=()=>{if(!txt.trim()) return; onAddComment(post.id,txt); setTxt("")};
        return (
          <div>
            <div className="flex items-center gap-3 mb-3">
              <button className="btn-sub" onClick={onClose}>ë‹«ê¸°</button>
              <h3 className="font-semibold">ìƒì„¸ ë³´ê¸°</h3>
            </div>
            <div className="card p-4">
              <div className="text-xs text-[var(--muted)] mb-1">{post.author} Â· {new Date(post.ts).toLocaleString()}</div>
              <div className="font-semibold">{post.title}</div>
              <p className="mt-1">{post.body}</p>
              {post.image && <img src={post.image} className="mt-2 rounded-lg border border-[var(--line)] max-h-96 object-contain w-full"/>}
              <div className="mt-2 flex gap-2 flex-wrap">{post.tags.map(t=> <Tag key={t}>{t}</Tag>)}</div>
              <div className="mt-3 text-sm text-[var(--muted)]"><button className="hover:underline" onClick={()=>onQuote(post)}>ì˜´í‘œ</button></div>
            </div>

            <div className="mt-4 card p-4">
              <div className="text-sm text-[var(--muted)] mb-2">ëŒ“ê¸€ {post.comments.length}</div>
              <div className="space-y-3 max-h-56 overflow-auto pr-1">
                {post.comments.map(c=> (
                  <div key={c.id} className="p-3 rounded-xl border border-[var(--line)] bg-white">
                    <div className="flex items-center justify-between">
                      <div className="text-xs text-[var(--muted)]">{c.author} Â· {new Date(c.ts).toLocaleString()}</div>
                      <div className="text-xs text-[var(--muted)] flex gap-2">
                        {me===c.author && <button className="hover:underline" onClick={()=>onDeleteComment(post.id,c.id)}>ì‚­ì œ</button>}
                        <button className="hover:underline" onClick={()=>alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤ (ë°ëª¨)')}>ì‹ ê³ </button>
                      </div>
                    </div>
                    <div className="mt-1">{c.text}</div>
                  </div>
                ))}
                {post.comments.length===0 && <div className="text-[var(--muted)] text-sm">ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”.</div>}
              </div>
              <div className="mt-3 flex gap-2">
                <input value={txt} onChange={e=>setTxt(e.target.value.slice(0,160))} placeholder="í•œ ì¤„ ëŒ“ê¸€" className="flex-1 rounded-lg px-3 py-2 bg-white border border-[var(--line)] placeholder-[var(--muted)] outline-none"/>
                <button className="btn" onClick={submit}>ë“±ë¡</button>
              </div>
            </div>
          </div>
        )
      };

      const Modal=({open,onClose,children})=> open? (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/10" onClick={onClose}></div>
          <div className="absolute inset-x-0 bottom-0 md:inset-0 md:m-auto md:h-[84vh] max-h-[92vh] overflow-auto mx-2 md:mx-auto md:max-w-2xl card p-4">{children}</div>
        </div>
      ):null;

      // -------------------------------------------------------------
      // App
      // -------------------------------------------------------------
      function App(){
        const [nick,setNick]=React.useState(load(NICK, randomNick()));
        const [posts,setPosts]=React.useState(load(DB, []));
        const [search,setSearch]=React.useState("");
        const [quote,setQuote]=React.useState(null);
        const [detail,setDetail]=React.useState(null);
        const [view,setView]=React.useState({mode:'feed'});
        const [visible,setVisible]=React.useState(6);
        const [confirm,setConfirm]=React.useState({open:false,text:'',action:null});

        React.useEffect(()=>save(NICK,nick),[nick]);
        React.useEffect(()=>save(DB,posts),[posts]);

        // seed
        React.useEffect(()=>{ if(posts.length===0){ setPosts([{id:uid(),title:'ì¢…ì´ì— ë²ˆì§€ëŠ” ê³µì§€',body:'ì‰í¬ê°€ ë§í•´ìš”: ê°€ë³ê²Œ ì ê³ , ê°€ë³ê²Œ ì½ê¸°.',tags:['ê³µì§€','ì—…ë°ì´íŠ¸'],author:'ì‹œìŠ¤í…œ',ts:Date.now()-100000,likes:2,likedBy:[],bookmarkedBy:[],image:null,comments:[],reports:0}]) } },[]);

        // infinite scroll
        React.useEffect(()=>{const f=()=>{if((window.innerHeight+window.scrollY)>=document.body.offsetHeight-200){setVisible(v=>Math.min(v+5, filtered().length))}};window.addEventListener('scroll',f);return()=>window.removeEventListener('scroll',f)},[posts,search,view]);

        const onNav=(v)=>{setView(v); setVisible(6); window.scrollTo({top:0})};

        const push=({title,body,tags,quoteTarget,image})=>{
          const base={id:uid(),title,body,tags,author:nick,ts:Date.now(),likes:0,likedBy:[],bookmarkedBy:[],image,comments:[],reports:0};
          if(quoteTarget){base.quoteOf={id:quoteTarget.id,title:quoteTarget.title,author:quoteTarget.author,body:quoteTarget.body}}
          setPosts([base,...posts]); setQuote(null); setVisible(6); window.scrollTo({top:0,behavior:'smooth'});
        };
        const addComment=(pid,text)=> setPosts(ps=>ps.map(p=> p.id===pid?{...p,comments:[...p.comments,{id:uid(),author:nick,text,ts:Date.now()}]}:p));
        const deleteComment=(pid,cid)=> setPosts(ps=>ps.map(p=> p.id===pid?{...p,comments:p.comments.filter(c=>c.id!==cid)}:p));
        const like=(id)=> setPosts(ps=>ps.map(p=>{ if(p.id!==id) return p; const mine=p.likedBy.includes(nick); const likedBy=mine?p.likedBy.filter(u=>u!==nick):[...p.likedBy,nick]; return {...p,likedBy,likes:mine?Math.max(0,p.likes-1):p.likes+1} }));
        const bookmark=(id)=> setPosts(ps=>ps.map(p=> p.id===id?{...p,bookmarkedBy:p.bookmarkedBy.includes(nick)?p.bookmarkedBy.filter(u=>u!==nick):[...p.bookmarkedBy,nick]}:p));
        const del=(id)=> setConfirm({open:true,text:'ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí• ê¹Œìš”?',action:()=>{setPosts(ps=>ps.filter(p=>p.id!==id)); setConfirm({open:false})}});
        const report=(id)=> setPosts(ps=>ps.map(p=> p.id===id?{...p,reports:(p.reports||0)+1}:p));

        const openAuthor=(author)=> onNav({mode:'profile',who:author===nick?'me':author});

        function filtered(){
          let list=posts.slice();
          if(view.mode==='profile'){
            const who = view.who==='me'?nick:view.who; list=list.filter(p=>p.author===who);
          } else if(view.mode==='bookmarks'){
            list=list.filter(p=>p.bookmarkedBy.includes(nick));
          }
          if(search.trim()){
            const k=search.toLowerCase(); list=list.filter(p=> [p.title,p.body,p.author,...p.tags].join(' ').toLowerCase().includes(k));
          }
          return list;
        }

        const list=filtered();

        return (
          <div>
            <Header nick={nick} onSearch={setSearch} onNav={onNav} view={view} />

            {/* background cats */}
            <div className="pointer-events-none fixed right-2 top-24 w-28 opacity-50"><InkCat mood={1} alpha={0.18}/></div>
            <div className="pointer-events-none fixed left-0 bottom-10 w-40 opacity-40"><InkCat mood={3} alpha={0.12}/></div>

            <main className="mx-auto max-w-3xl px-4 py-6 space-y-6">
              <div className="flex items-center justify-between text-xs text-[var(--muted)]">
                <div className="flex items-center gap-2">
                  <button className="btn-sub" onClick={()=>setNick(randomNick())}>ë‹‰ë„¤ì„ ë³€ê²½</button>
                  {view.mode==='profile' && <span>í”„ë¡œí•„: {view.who==='me'?nick:view.who}</span>}
                  {view.mode==='bookmarks' && <span>ë¶ë§ˆí¬</span>}
                </div>
              </div>

              <Composer nick={nick} quoteTarget={quote} onCancelQuote={()=>setQuote(null)} onPost={push}/>

              {list.length===0 && <div className="text-center text-[var(--muted)]">ê²°ê³¼ê°€ ì—†ì–´ìš”.</div>}
              <div className="space-y-5">
                {list.slice(0,visible).map(p=> (
                  <PostCard key={p.id}
                    post={p} me={nick}
                    liked={p.likedBy.includes(nick)}
                    bm={p.bookmarkedBy.includes(nick)}
                    onOpen={setDetail}
                    onQuote={setQuote}
                    onLike={like}
                    onBookmark={bookmark}
                    onAuthor={openAuthor}
                    onDelete={del}
                    onReport={report}
                  />
                ))}
              </div>
              {visible<list.length && <div className="text-center text-[var(--muted)]">ìŠ¤í¬ë¡¤í•˜ë©´ ë” ë¶ˆëŸ¬ì™€ìš”â€¦</div>}
            </main>

            <footer className="mx-auto max-w-3xl px-4 py-10 text-center text-xs text-[var(--muted)]">Â© ${new Date().getFullYear()} OVRA Â· ink & paper</footer>

            {/* detail modal */}
            <Modal open={!!detail} onClose={()=>setDetail(null)}>
              {detail && <PostDetail me={nick} post={detail} onClose={()=>setDetail(null)} onAddComment={addComment} onDeleteComment={deleteComment} onQuote={setQuote}/>} 
            </Modal>

            <Confirm open={confirm.open} text={confirm.text} onNo={()=>setConfirm({open:false})} onYes={()=>{confirm.action?.()}}/>
          </div>
        );
      }

      const root=ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App/>);
    </script>
  </body>
</html>
